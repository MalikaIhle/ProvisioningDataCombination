#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#	 Malika IHLE & Joel PICK  malika_ihle@hotmail.fr & joel.l.pick@gmail.com
#	 Handling output of simulations running on iceberg 
#	 Start : 22/03/2017
#	 last modif : 22/03/2017
#	 commit: call all files generated by simulation running on iceberg
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

rm(list = ls(all = TRUE))

require(stringr)
library(qdap)

# import log files
fileNamesLog <- list.files("Iceberg/Sim1_log") # vector of filenames
Logs <- do.call(rbind,lapply(paste("Iceberg/Sim1_log",fileNamesLog, sep="/"), FUN= function(x){str_c(readLines(x), collapse = " ")}))
Logs[1]
Logs <- gsub("^.*union","_",Logs) # only keep the warning which come after log of packages loaded
Logs <- data.frame(FileName=fileNamesLog, Log = Logs)
PbLogs <- Logs$FileName[Logs$Log != "_ "] # 547 sim where one model did not converge
PbLogs_Type <- gsub("\\..*","",PbLogs) # sim type where models did not converge

table(PbLogs_Type)
# models did not converge in those x cases out of 1000
# sim_1_1 sim_1_2 sim_1_3 sim_1_4 sim_1_5 sim_1_6 
#	 35      35     203     189      77       8

PbLogs_sim <- paste(beg2char(PbLogs, ".", 1),char2end(PbLogs, ".", 3), sep="_")# sim name where model did not converge
PbLogs_sim <- paste("sim1", char2end(PbLogs_sim, "_", 2), sep="_")

# import files
fileNames <- list.files("Iceberg/Sim1_out") # vector of filenames
fileList <- lapply(paste("Iceberg/Sim1_out",fileNames, sep="/"), read.csv) # list with one file per element named from 1 to 6000
for (i in 1:length(fileList)) {names(fileList)[[i]]<-gsub("\\..*","",fileNames[i])} # change name of each element to be the sim name
fileList <- fileList[!names(fileList) %in% PbLogs_sim] # remove filenames where one model did not converge

# select files per Sim type
fileList_Sim1_1 <- fileList[grepl("sim1_1",names(fileList))] 
fileList_Sim1_2 <- fileList[grepl("sim1_2",names(fileList))] 
fileList_Sim1_3 <- fileList[grepl("sim1_3",names(fileList))] 
fileList_Sim1_4 <- fileList[grepl("sim1_4",names(fileList))] 
fileList_Sim1_5 <- fileList[grepl("sim1_5",names(fileList))] 
fileList_Sim1_6 <- fileList[grepl("sim1_6",names(fileList))] 

# Number of files per sim type
NreplicatesSimulation <- c(
length(fileList_Sim1_1), # 965
length(fileList_Sim1_2), # 965
length(fileList_Sim1_3), # 797
length(fileList_Sim1_4), # 811
length(fileList_Sim1_5), # 923
length(fileList_Sim1_6)) # 992

# Function counting number of significant result as a percentage of NreplicatesSimulation
Shape_results <- function(MY_Results, TypeNumber){

sorted_results <- lapply(MY_Results, function(x){ 
subx <- x[,-1] 
subx <- subx[ , order(names(subx))] 
cbind(Factor=x[,1], subx)
})

Signi_results <- lapply(sorted_results, function(x){
x_p <- x[,-(1:((ncol(x)+1)/2))]
x_e <- x[,c(-1,-(((ncol(x)-1)/2+2):ncol(x)))]

cbind(x_p < 0.05, x_e)
})

results_Sign_compiled <- Reduce('+',Signi_results)/NreplicatesSimulation[TypeNumber]
results_Sign_compiled <- cbind(results_Sign_compiled[,c(-(((ncol(results_Sign_compiled))/2+1):ncol(results_Sign_compiled)))]*100,
										results_Sign_compiled[,-(1:((ncol(results_Sign_compiled))/2))])
results_Sign_compiled <- round(results_Sign_compiled,2)
results_PercentageFactorSignificant <- data.frame(Factor=MY_Results[[1]]$Factor,results_Sign_compiled)

return(results_PercentageFactorSignificant)

}

# shape results Sim 1
Results_Sim_1 <- c(
list(Shape_results(fileList_Sim1_1,1)), # no_autocor_no_cor
list(Shape_results(fileList_Sim1_2,2)), # no_autocor_corCN
list(Shape_results(fileList_Sim1_3,3)), # full_autocor_no_cor
list(Shape_results(fileList_Sim1_4,4)), # full_autocor_corCN
list(Shape_results(fileList_Sim1_5,5)), # partial_autocor_no_cor
list(Shape_results(fileList_Sim1_6,6))) # partial_autocor_corCN



Results_Sim_1



# [[1]]
                    # Factor p_modA p_modA_Ben p_modA_simple p_modAbin p_modAdev p_modS p_modSdev e_modA e_modA_simple e_modABen e_modAbin e_modAdev e_modS e_modSdev
# 1              (Intercept) 100.00     100.00         100.0    100.00     12.95 100.00     26.84   2.61          2.61      0.45      0.63      0.04   1.92      0.06
# 2                scale(CN)   0.41       5.28           2.9      0.31      5.49   0.83      5.28   0.00          0.00      0.00      0.00      0.00   0.00      0.00
# 3             scale(DiffP) 100.00     100.00         100.0    100.00     13.47 100.00      7.46  -0.20         -0.19     -0.07      0.51     -0.05  -0.21     -0.01
# 4            scale(TotalP) 100.00         NA         100.0    100.00     14.09 100.00     11.30   0.44          0.42        NA     -0.20      0.03   0.65      0.00
# 5               Typez_Obsv   0.00         NA            NA      0.83        NA   0.52        NA   0.00            NA        NA      0.01        NA   0.01        NA
# 6     Typez_Obsv:scale(CN)   0.00         NA            NA      0.31        NA   0.00        NA   0.00            NA        NA      0.00        NA   0.00        NA
# 7  Typez_Obsv:scale(DiffP)   0.00         NA            NA      1.14        NA   0.00        NA   0.00            NA        NA     -0.01        NA   0.00        NA
# 8 Typez_Obsv:scale(TotalP)   0.00         NA            NA      0.21        NA   0.00        NA   0.00            NA        NA      0.00        NA   0.00        NA

# [[2]]
                    # Factor p_modA p_modA_Ben p_modA_simple p_modAbin p_modAdev p_modS p_modSdev e_modA e_modA_simple e_modABen e_modAbin e_modAdev e_modS e_modSdev
# 1              (Intercept)    100        100           100    100.00     16.27 100.00     28.19   2.63          2.64      0.47      0.53      0.05   1.93      0.06
# 2                scale(CN)    100        100           100      0.62      5.70 100.00      3.94   0.04          0.04      0.02      0.00      0.00   0.07      0.00
# 3             scale(DiffP)    100        100           100    100.00     13.89 100.00      8.70  -0.13         -0.13     -0.05      0.40     -0.04  -0.14     -0.01
# 4            scale(TotalP)    100         NA           100    100.00     12.85 100.00     12.95   0.43          0.40        NA     -0.18      0.02   0.64      0.00
# 5               Typez_Obsv      0         NA            NA      1.45        NA   0.62        NA   0.00            NA        NA      0.01        NA   0.01        NA
# 6     Typez_Obsv:scale(CN)      0         NA            NA      0.31        NA   0.00        NA   0.00            NA        NA      0.00        NA   0.00        NA
# 7  Typez_Obsv:scale(DiffP)      0         NA            NA      0.93        NA   0.00        NA   0.00            NA        NA     -0.01        NA   0.00        NA
# 8 Typez_Obsv:scale(TotalP)      0         NA            NA      0.31        NA   0.00        NA   0.00            NA        NA      0.00        NA   0.00        NA

# [[3]]
                    # Factor p_modA p_modA_Ben p_modA_simple p_modAbin p_modAdev p_modS p_modSdev e_modA e_modA_simple e_modABen e_modAbin e_modAdev e_modS e_modSdev
# 1              (Intercept) 100.00     100.00        100.00    100.00    100.00 100.00    100.00   2.60          2.83      0.56      0.64      4.03   1.91      3.20
# 2                scale(CN)   0.38       4.02          4.64      0.38      4.89   0.38      4.14   0.00          0.00      0.00      0.00      0.00   0.00      0.00
# 3             scale(DiffP) 100.00     100.00        100.00    100.00    100.00 100.00    100.00  -0.20         -0.27     -0.10      0.52     -2.77  -0.22     -1.60
# 4            scale(TotalP) 100.00         NA        100.00    100.00    100.00 100.00    100.00   0.45          0.50        NA     -0.20      3.88   0.67      3.12
# 5               Typez_Obsv 100.00         NA            NA    100.00        NA 100.00        NA   0.22            NA        NA      0.82        NA   0.32        NA
# 6     Typez_Obsv:scale(CN)   0.00         NA            NA      5.65        NA   0.00        NA   0.00            NA        NA      0.00        NA   0.00        NA
# 7  Typez_Obsv:scale(DiffP) 100.00         NA            NA     13.17        NA 100.00        NA  -0.08            NA        NA     -0.01        NA  -0.05        NA
# 8 Typez_Obsv:scale(TotalP) 100.00         NA            NA    100.00        NA  97.62        NA   0.07            NA        NA      0.24        NA   0.03        NA

# [[4]]
                    # Factor p_modA p_modA_Ben p_modA_simple p_modAbin p_modAdev p_modS p_modSdev e_modA e_modA_simple e_modABen e_modAbin e_modAdev e_modS e_modSdev
# 1              (Intercept) 100.00        100           100    100.00    100.00 100.00     100.0   2.62          2.86      0.59      0.54      4.56   1.92      3.55
# 2                scale(CN)  99.88        100           100      0.74     12.33 100.00      21.7   0.04          0.05      0.05      0.00     -0.07   0.07     -0.10
# 3             scale(DiffP) 100.00        100           100    100.00    100.00 100.00     100.0  -0.14         -0.20     -0.09      0.41     -2.48  -0.15     -1.37
# 4            scale(TotalP) 100.00         NA           100    100.00    100.00 100.00     100.0   0.45          0.49        NA     -0.18      4.63   0.67      3.77
# 5               Typez_Obsv 100.00         NA            NA    100.00        NA 100.00        NA   0.24            NA        NA      0.83        NA   0.33        NA
# 6     Typez_Obsv:scale(CN)   0.62         NA            NA     18.37        NA   0.12        NA   0.01            NA        NA      0.02        NA   0.00        NA
# 7  Typez_Obsv:scale(DiffP) 100.00         NA            NA     22.56        NA 100.00        NA  -0.06            NA        NA      0.02        NA  -0.04        NA
# 8 Typez_Obsv:scale(TotalP) 100.00         NA            NA    100.00        NA  77.19        NA   0.06            NA        NA      0.23        NA   0.03        NA

# [[5]]
                    # Factor p_modA p_modA_Ben p_modA_simple p_modAbin p_modAdev p_modS p_modSdev e_modA e_modA_simple e_modABen e_modAbin e_modAdev e_modS e_modSdev
# 1              (Intercept) 100.00        100           100    100.00       100 100.00       100   2.57          2.74      0.52      0.52      3.08   1.88      2.62
# 2                scale(CN)  27.19        100           100     54.17       100  31.85       100   0.01          0.08      0.04      0.02      1.21   0.02      1.00
# 3             scale(DiffP) 100.00        100           100    100.00       100 100.00       100  -0.22         -0.27     -0.08      0.41     -2.21  -0.23     -1.44
# 4            scale(TotalP) 100.00         NA           100    100.00       100 100.00       100   0.47          0.52        NA     -0.11      3.35   0.69      2.80
# 5               Typez_Obsv 100.00         NA            NA    100.00        NA 100.00        NA   0.17            NA        NA      0.56        NA   0.26        NA
# 6     Typez_Obsv:scale(CN) 100.00         NA            NA    100.00        NA 100.00        NA   0.07            NA        NA      0.29        NA   0.09        NA
# 7  Typez_Obsv:scale(DiffP) 100.00         NA            NA     73.35        NA 100.00        NA  -0.06            NA        NA     -0.06        NA  -0.04        NA
# 8 Typez_Obsv:scale(TotalP) 100.00         NA            NA    100.00        NA 100.00        NA   0.07            NA        NA      0.25        NA   0.04        NA

# [[6]]
                    # Factor p_modA p_modA_Ben p_modA_simple p_modAbin p_modAdev p_modS p_modSdev e_modA e_modA_simple e_modABen e_modAbin e_modAdev e_modS e_modSdev
# 1              (Intercept)    100        100           100    100.00       100 100.00       100   2.59          2.79      0.55      0.43      4.04   1.88      3.41
# 2                scale(CN)    100        100           100     68.15       100 100.00       100   0.05          0.11      0.09      0.03      0.78   0.09      0.55
# 3             scale(DiffP)    100        100           100    100.00       100 100.00       100  -0.15         -0.20     -0.08      0.34     -2.38  -0.16     -1.51
# 4            scale(TotalP)    100         NA           100    100.00       100 100.00       100   0.47          0.50        NA     -0.12      4.62   0.68      3.92
# 5               Typez_Obsv    100         NA            NA    100.00        NA 100.00        NA   0.19            NA        NA      0.63        NA   0.29        NA
# 6     Typez_Obsv:scale(CN)    100         NA            NA    100.00        NA 100.00        NA   0.06            NA        NA      0.23        NA   0.07        NA
# 7  Typez_Obsv:scale(DiffP)    100         NA            NA      7.56        NA 100.00        NA  -0.06            NA        NA      0.00        NA  -0.04        NA
# 8 Typez_Obsv:scale(TotalP)    100         NA            NA    100.00        NA  51.81        NA   0.06            NA        NA      0.28        NA   0.02        NA








